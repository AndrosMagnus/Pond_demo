<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Demo estanques (PMTiles + satélite)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>

  <!-- PMTiles -->
  <script src="https://unpkg.com/pmtiles@latest/dist/pmtiles.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #020617;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #app {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      height: 100vh;
    }
    #left-panel, #right-panel {
      background: #020617;
      padding: 12px;
      color: #e5e7eb;
      border-right: 1px solid #1f2937;
      overflow-y: auto;
    }
    #right-panel { border-right: 0; border-left: 1px solid #1f2937; }
    h2 { margin: 0 0 10px 0; font-size: 15px; color: #f9fafb; }
    p { margin: 0 0 6px 0; font-size: 13px; color: #9ca3af; }
    label {
      display: block; margin-top: 8px; margin-bottom: 3px;
      font-size: 11px; text-transform: uppercase;
      color: #9ca3af; letter-spacing: 0.05em;
    }
    select, button {
      width: 100%; padding: 6px;
      border-radius: 6px; margin-bottom: 8px;
      border: 1px solid #4b5563; background: #020617;
      color: #e5e7eb; font-size: 13px;
    }
    button:hover { background: #111827; cursor: pointer; }
    #mapContainer { width: 100%; height: 100%; }
    #zoom-info {
      position: absolute;
      left: 10px; bottom: 10px;
      background: rgba(15,23,42,0.9);
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      color: white;
      pointer-events: none;
    }
  </style>
</head>

<body>
<div id="app">

  <!-- Panel izquierdo: info del estanque -->
  <div id="left-panel">
    <h2>Estanque seleccionado</h2>
    <p><strong>ID:</strong> –</p>
    <p><strong>País:</strong> –</p>
    <p><strong>Región:</strong> –</p>
    <p><strong>Lugar:</strong> –</p>
    <p><strong>Área (ha):</strong> –</p>
  </div>

  <!-- Mapa -->
  <div id="map" style="position:relative;">
    <div id="mapContainer"></div>
    <div id="zoom-info">Acerca el zoom para ver los estanques.</div>
  </div>

  <!-- Panel derecho: filtros (luego los conectamos bien) -->
  <div id="right-panel">
    <h2>Filtro espacial</h2>

    <label>País</label>
    <select id="country-select">
      <option value="">Todos</option>
    </select>

    <label>Región</label>
    <select id="region-select" disabled>
      <option value="">–</option>
    </select>

    <label>Lugar (place)</label>
    <select id="place-select" disabled>
      <option value="">–</option>
    </select>

    <p style="margin-top:10px;">
      <strong>Número de estanques:</strong> <span id="count-output">–</span>
    </p>
    <p>
      <strong>Área total (ha):</strong> <span id="area-output">–</span>
    </p>

    <button id="reset-view">Reset vista</button>
  </div>

</div>

<script>
  // ---------------------------
  // 1. Basemap satelital ESRI
  // ---------------------------
  const satelliteStyle = {
    version: 8,
    sources: {
      esri_satellite: {
        type: "raster",
        tiles: [
          "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
        ],
        tileSize: 256
      }
    },
    layers: [
      {
        id: "esri_satellite",
        type: "raster",
        source: "esri_satellite"
      }
    ]
  };

  const map = new maplibregl.Map({
    container: "mapContainer",
    style: satelliteStyle,
    center: [-79.9, -2.3], // Costa de Ecuador
    zoom: 6
  });

  // ---------------------------
  // 2. Cargar piscinas.pmtiles
  // ---------------------------

  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // Usa la URL absoluta del archivo en GitHub Pages
  const PMTILES_URL = "https://androsmagnus.github.io/Pond_demo/piscinas.pmtiles";

  // Instancia PMTiles y la registramos en el protocolo
  const pmSource = new pmtiles.PMTiles(PMTILES_URL);
  protocol.add(pmSource); // ¡OJO! solo el objeto, no la URL

  const pondsSourceId  = "estanques";
  const pondsLayerId   = "estanques-fill";
  const pondsOutlineId = "estanques-outline";

  map.on("load", async () => {
    try {
      // Leer header para saber el nombre de la capa interna
      const header = await pmSource.getHeader();
      const layerName = header.name || "layer";
      console.log("Layer interna en PMTiles:", layerName);

      // Fuente vectorial basada en PMTiles
      map.addSource(pondsSourceId, {
        type: "vector",
        url: "pmtiles://" + PMTILES_URL
      });

      // Capa de relleno
      map.addLayer({
        id: pondsLayerId,
        type: "fill",
        source: pondsSourceId,
        "source-layer": layerName,
        paint: {
          "fill-color": "#22c55e",
          "fill-opacity": 0.45
        }
      });

      // Capa de borde
      map.addLayer({
        id: pondsOutlineId,
        type: "line",
        source: pondsSourceId,
        "source-layer": layerName,
        paint: {
          "line-color": "#166534",
          "line-width": 0.8
        }
      });

      setupInteractions(layerName);
    } catch (err) {
      console.error("Error cargando PMTiles:", err);
      document.getElementById("zoom-info").textContent =
        "No se pudo cargar piscinas.pmtiles (revisa la URL y el nombre del archivo).";
    }
  });

  // ---------------------------
  // 3. Interacción y lectura de atributos desde el PMTiles
  // ---------------------------
  function setupInteractions(layerName) {
    const leftPanel   = document.getElementById("left-panel");
    const zoomInfo    = document.getElementById("zoom-info");
    const countOutput = document.getElementById("count-output");
    const areaOutput  = document.getElementById("area-output");

    // Helper para buscar un campo entre varios posibles nombres
    function pickProp(props, candidates, fallback = "–") {
      for (const c of candidates) {
        if (props[c] !== undefined && props[c] !== null) return props[c];
      }
      return fallback;
    }

    // Cursor tipo mano sobre estanques
    map.on("mouseenter", pondsLayerId, () => {
      map.getCanvas().style.cursor = "pointer";
    });
    map.on("mouseleave", pondsLayerId, () => {
      map.getCanvas().style.cursor = "";
    });

    // Click en estanque → mostrar info en panel izquierdo
    map.on("click", pondsLayerId, (e) => {
      const feat = e.features && e.features[0];
      if (!feat) return;
      const props = feat.properties || {};

      // Intentamos mapear country / region / place / area desde las props del PMTiles
      const id     = pickProp(props, ["id", "ID", "pond_id"]);
      const pais   = pickProp(props, ["country", "COUNTRY", "pais", "PAIS"]);
      const region = pickProp(props, ["region", "REGION", "provincia", "PROVINCIA", "state"]);
      const lugar  = pickProp(props, ["place", "PLACE", "parroquia", "PARROQUIA", "cantón", "CANTON", "canton"]);
      const area   = pickProp(props, ["area_ha", "AREA_HA", "area", "AREA"]);

      let html = "<h2>Estanque seleccionado</h2>";
      html += `<p><strong>ID:</strong> ${id}</p>`;
      html += `<p><strong>País:</strong> ${pais}</p>`;
      html += `<p><strong>Región:</strong> ${region}</p>`;
      html += `<p><strong>Lugar:</strong> ${lugar}</p>`;
      html += `<p><strong>Área (ha):</strong> ${area}</p>`;
      html += `<hr style="border-color:#1f2937; margin:8px 0;">`;
      html += `<p style="font-size:11px; text-transform:uppercase; letter-spacing:.05em; color:#6b7280;">Todas las propiedades del feature</p>`;

      // Debajo mostramos todas las propiedades tal cual vienen del PMTiles (debug útil)
      for (const key in props) {
        html += `<p><strong>${key}:</strong> ${props[key]}</p>`;
      }

      leftPanel.innerHTML = html;
    });

    // Mostrar / ocultar mensaje según zoom
    function updateZoomHint() {
      const z = map.getZoom();
      zoomInfo.style.display = z < 8 ? "block" : "none";
    }
    map.on("moveend", updateZoomHint);
    updateZoomHint();

    // Cálculo simple de número de estanques y área total visibles (demo)
    function updateStats() {
      try {
        const features = map.querySourceFeatures(pondsSourceId, {
          sourceLayer: layerName
        });
        const count = features.length;
        let totalArea = 0;

        for (const f of features) {
          const props = f.properties || {};
          const a = parseFloat(
            pickProp(props, ["area_ha", "AREA_HA", "area", "AREA"], "0")
          );
          if (!isNaN(a)) totalArea += a;
        }

        countOutput.textContent = count || "0";
        areaOutput.textContent = totalArea ? totalArea.toFixed(2) : "0";
      } catch (e) {
        // puede fallar si la fuente aún no está lista; no pasa nada
      }
    }

    map.on("moveend", updateStats);
    map.on("load", updateStats);
    updateStats();

    // Botón reset vista
    document.getElementById("reset-view").addEventListener("click", () => {
      map.flyTo({ center: [-79.9, -2.3], zoom: 6 });
    });
  }
</script>

</body>
</html>
