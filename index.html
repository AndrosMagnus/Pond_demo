<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Demo estanques (PMTiles + satélite)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>

  <!-- PMTiles -->
  <script src="https://unpkg.com/pmtiles@latest/dist/pmtiles.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #020617;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #app {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      height: 100vh;
    }
    #left-panel, #right-panel {
      background: #020617;
      padding: 12px;
      color: #e5e7eb;
      border-right: 1px solid #1f2937;
      overflow-y: auto;
    }
    #right-panel { border-right: 0; border-left: 1px solid #1f2937; }
    h2 { margin: 0 0 10px 0; font-size: 15px; color: #f9fafb; }
    p { margin: 0 0 6px 0; font-size: 13px; color: #9ca3af; }
    label {
      display: block; margin-top: 8px; margin-bottom: 3px;
      font-size: 11px; text-transform: uppercase;
      color: #9ca3af; letter-spacing: 0.05em;
    }
    select, button {
      width: 100%; padding: 6px;
      border-radius: 6px; margin-bottom: 8px;
      border: 1px solid #4b5563; background: #020617;
      color: #e5e7eb; font-size: 13px;
    }
    button:hover { background: #111827; cursor: pointer; }
    #mapContainer { width: 100%; height: 100%; }
    #zoom-info {
      position: absolute;
      left: 10px; bottom: 10px;
      background: rgba(15,23,42,0.9);
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      color: white;
      pointer-events: none;
    }
    .opacity-control {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }
    .opacity-control input[type="range"] {
      flex: 1;
    }
    .opacity-control button {
      width: auto;
      padding: 6px 10px;
    }
  </style>
</head>

<body>
<div id="app">

  <!-- Panel izquierdo: info del estanque -->
  <div id="left-panel">
    <h2>Estanque seleccionado</h2>
    <p><strong>ID:</strong> -</p>
    <p><strong>País:</strong> -</p>
    <p><strong>Región:</strong> -</p>
    <p><strong>Lugar:</strong> -</p>
    <p><strong>Área (ha):</strong> -</p>
  </div>

  <!-- Mapa -->
  <div id="map" style="position:relative;">
    <div id="mapContainer"></div>
    <div id="zoom-info">Acerca el zoom para ver los estanques.</div>
  </div>

  <!-- Panel derecho: filtros (luego los conectamos bien) -->
  <div id="right-panel">
    <h2>Filtro espacial</h2>

    <label>País</label>
    <select id="country-select">
      <option value="">Todos</option>
    </select>

    <label>Región</label>
    <select id="region-select" disabled>
      <option value="">-</option>
    </select>

    <label>Lugar (place)</label>
    <select id="place-select" disabled>
      <option value="">-</option>
    </select>

    <p style="margin-top:10px;">
      <strong>Número de estanques:</strong> <span id="count-output">-</span>
    </p>
    <p>
      <strong>Área total (ha):</strong> <span id="area-output">–</span>
    </p>

    <button id="reset-view">Reset vista</button>

    <label for="fill-opacity" style="margin-top:16px;">Opacidad de estanques</label>
    <div class="opacity-control">
      <input
        id="fill-opacity"
        type="range"
        min="10"
        max="100"
        step="5"
        value="45"
      />
      <button id="opacity-reset" type="button">Reset</button>
    </div>
    <p style="font-size:12px; margin-top:-4px;">
      Valor actual: <strong><span id="opacity-value">0.45</span></strong>
    </p>
  </div>

</div>

<script>
  // ---------------------------
  // 1. Basemap satelital ESRI
  // ---------------------------
  const satelliteStyle = {
    version: 8,
    sources: {
      esri_satellite: {
        type: "raster",
        tiles: [
          "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
        ],
        tileSize: 256
      }
    },
    layers: [
      {
        id: "esri_satellite",
        type: "raster",
        source: "esri_satellite"
      }
    ]
  };

  const defaultView = { center: [-79.9, -2.3], zoom: 6 };

  const map = new maplibregl.Map({
    container: "mapContainer",
    style: satelliteStyle,
    center: defaultView.center,
    zoom: defaultView.zoom
  });

  const countrySelect = document.getElementById("country-select");
  const regionSelect = document.getElementById("region-select");
  const placeSelect = document.getElementById("place-select");
  const countOutput = document.getElementById("count-output");
  const areaOutput = document.getElementById("area-output");
  const fillOpacityInput = document.getElementById("fill-opacity");
  const opacityValueLabel = document.getElementById("opacity-value");
  const opacityResetBtn = document.getElementById("opacity-reset");

  const filtersState = {
    countries: {},
    totals: { count: 0, area: 0 },
    loaded: false
  };

  const mapPadding = { top: 40, bottom: 40, left: 320, right: 320 };
  const defaultFillValue = Number(fillOpacityInput.value);
  const defaultFillOpacity = defaultFillValue / 100;
  opacityValueLabel.textContent = defaultFillOpacity.toFixed(2);

  function formatCount(value) {
    return value?.toLocaleString("es-EC") ?? "0";
  }

  function formatArea(value) {
    if (value === undefined || value === null) return "0";
    return Number(value).toLocaleString("es-EC", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function updateStatsDisplay(stats) {
    if (!stats) {
      countOutput.textContent = "-";
      areaOutput.textContent = "-";
      return;
    }
    countOutput.textContent = formatCount(stats.count);
    areaOutput.textContent = formatArea(stats.area);
  }

  function setSelectOptions(selectEl, options, placeholderText) {
    selectEl.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = placeholderText;
    selectEl.appendChild(placeholder);
    options.forEach((opt) => {
      const optionNode = document.createElement("option");
      optionNode.value = opt.value;
      optionNode.textContent = opt.label;
      selectEl.appendChild(optionNode);
    });
    selectEl.disabled = options.length === 0;
  }

  function computeTotals(countries) {
    const stats = { count: 0, area: 0 };
    Object.values(countries).forEach((country) => {
      stats.count += country.count || 0;
      stats.area += country.area || 0;
    });
    return stats;
  }

  function flyToStats(stats) {
    if (!stats) return;
    const run = () => {
      if (stats.bbox) {
        const [[minLng, minLat], [maxLng, maxLat]] = [
          [stats.bbox[0], stats.bbox[1]],
          [stats.bbox[2], stats.bbox[3]]
        ];
        const sameLon = minLng === maxLng;
        const sameLat = minLat === maxLat;
        if (!sameLon || !sameLat) {
          map.fitBounds(
            [
              [minLng, minLat],
              [maxLng, maxLat]
            ],
            { padding: mapPadding, duration: 800 }
          );
          return;
        }
      }
      if (stats.center) {
        map.flyTo({ center: stats.center, zoom: Math.max(map.getZoom(), 10) });
      }
    };
    if (map.isStyleLoaded()) {
      run();
    } else {
      map.once("load", run);
    }
  }

  function resetFilters(preserveCountryOptions = false) {
    if (!preserveCountryOptions) {
      setSelectOptions(countrySelect, [], "Todos");
    } else {
      countrySelect.value = "";
    }
    setSelectOptions(regionSelect, [], "-");
    setSelectOptions(placeSelect, [], "-");
    regionSelect.disabled = true;
    placeSelect.disabled = true;
    const stats = filtersState.loaded ? filtersState.totals : null;
    updateStatsDisplay(stats);
  }

  resetFilters();

  document.getElementById("reset-view").addEventListener("click", () => {
    resetFilters(true);
    map.flyTo(defaultView);
  });

  function applyFillOpacity(opacity) {
    const clamped = Math.min(1, Math.max(0, opacity));
    opacityValueLabel.textContent = clamped.toFixed(2);
    if (map.getLayer(pondsLayerId)) {
      map.setPaintProperty(pondsLayerId, "fill-opacity", clamped);
    }
  }

  fillOpacityInput.addEventListener("input", (event) => {
    const value = Number(event.target.value) / 100;
    applyFillOpacity(value);
  });

  opacityResetBtn.addEventListener("click", () => {
    fillOpacityInput.value = String(defaultFillValue);
    applyFillOpacity(defaultFillOpacity);
  });

  function getCountryData(name) {
    if (!name || !filtersState.countries) return null;
    return filtersState.countries[name] || null;
  }

  function getRegionData(countryData, regionName) {
    if (!countryData || !regionName) return null;
    return (countryData.regions || {})[regionName] || null;
  }

  function populateCountrySelect() {
    const entries = Object.keys(filtersState.countries || {})
      .sort((a, b) => a.localeCompare(b, "es"))
      .map((name) => ({
        value: name,
        label: `${name} (${formatCount(filtersState.countries[name].count)})`
      }));
    setSelectOptions(countrySelect, entries, "Todos");
    countrySelect.disabled = entries.length === 0;
  }

  function populateRegionSelect(countryData) {
    const regions = countryData?.regions || {};
    const entries = Object.keys(regions)
      .sort((a, b) => a.localeCompare(b, "es"))
      .map((name) => ({
        value: name,
        label: `${name} (${formatCount(regions[name].count)})`
      }));
    setSelectOptions(regionSelect, entries, entries.length ? "Todas" : "-");
    if (!entries.length) {
      setSelectOptions(placeSelect, [], "-");
      placeSelect.disabled = true;
    }
  }

  function populatePlaceSelect(regionData) {
    const places = regionData?.places || {};
    const entries = Object.keys(places)
      .sort((a, b) => a.localeCompare(b, "es"))
      .map((name) => ({
        value: name,
        label: `${name} (${formatCount(places[name].count)})`
      }));
    setSelectOptions(placeSelect, entries, entries.length ? "Todos" : "-");
  }

  countrySelect.addEventListener("change", () => {
    if (!filtersState.loaded) return;
    const countryName = countrySelect.value;
    const countryData = getCountryData(countryName);

    regionSelect.value = "";
    placeSelect.value = "";
    populateRegionSelect(countryData);
    setSelectOptions(placeSelect, [], "-");
    placeSelect.disabled = true;

    if (!countryData) {
      updateStatsDisplay(filtersState.totals);
      return map.flyTo(defaultView);
    }

    updateStatsDisplay(countryData);
    flyToStats(countryData);
  });

  regionSelect.addEventListener("change", () => {
    const countryData = getCountryData(countrySelect.value);
    if (!countryData) return;

    const regionName = regionSelect.value;
    const regionData = getRegionData(countryData, regionName);

    placeSelect.value = "";
    populatePlaceSelect(regionData);

    if (!regionData) {
      updateStatsDisplay(countryData);
      return flyToStats(countryData);
    }

    updateStatsDisplay(regionData);
    flyToStats(regionData);
  });

  placeSelect.addEventListener("change", () => {
    const countryData = getCountryData(countrySelect.value);
    if (!countryData) return;
    const regionData = getRegionData(countryData, regionSelect.value);
    if (!regionData) return;

    const placeName = placeSelect.value;
    if (!placeName) {
      updateStatsDisplay(regionData);
      return flyToStats(regionData);
    }

    const placeData = (regionData.places || {})[placeName];
    if (!placeData) return;

    updateStatsDisplay(placeData);
    flyToStats(placeData);
  });

  fetch("pond_filters.json")
    .then((resp) => {
      if (!resp.ok) throw new Error("No se pudo leer pond_filters.json");
      return resp.json();
    })
    .then((data) => {
      filtersState.countries = data.countries || {};
      filtersState.totals = computeTotals(filtersState.countries);
      filtersState.loaded = true;
      populateCountrySelect();
      resetFilters(true);
      updateStatsDisplay(filtersState.totals);
    })
    .catch((err) => {
      console.error("Error cargando filtros:", err);
      updateStatsDisplay(null);
    });

  // ---------------------------
  // 2. Cargar piscinas.pmtiles
  // ---------------------------

  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // Usa la URL absoluta del archivo en GitHub Pages
  const PMTILES_URL = "https://androsmagnus.github.io/Pond_demo/piscinas.pmtiles";

  // Instancia PMTiles y la registramos en el protocolo
  const pmSource = new pmtiles.PMTiles(PMTILES_URL);
  protocol.add(pmSource); // ¡OJO! solo el objeto, no la URL

  const pondsSourceId  = "estanques";
  const pondsLayerId   = "estanques-fill";
  const pondsOutlineId = "estanques-outline";

  map.on("load", async () => {
    try {
      // Leer header para saber el nombre de la capa interna
      const header = await pmSource.getHeader();
      let layerName = (header && header.name) || null;

      // Algunos PMTiles no rellenan header.name, asi que consultamos el metadata
      try {
        const metadata = await pmSource.getMetadata();
        const vectorLayers = metadata?.vector_layers || metadata?.layers;
        if (Array.isArray(vectorLayers) && vectorLayers.length > 0) {
          layerName = vectorLayers[0].id || layerName;
        }
      } catch (metadataErr) {
        console.warn("No se pudo leer metadata de PMTiles:", metadataErr);
      }

      if (!layerName) {
        layerName = "layer";
      }
      console.log("Capa interna usada en PMTiles:", layerName);

      // Fuente vectorial basada en PMTiles
      map.addSource(pondsSourceId, {
        type: "vector",
        url: "pmtiles://" + PMTILES_URL
      });

      // Capa de relleno
      map.addLayer({
        id: pondsLayerId,
        type: "fill",
        source: pondsSourceId,
        "source-layer": layerName,
        paint: {
          "fill-color": "#f97316",
          "fill-opacity": defaultFillOpacity
        }
      });

      // Capa de borde
      map.addLayer({
        id: pondsOutlineId,
        type: "line",
        source: pondsSourceId,
        "source-layer": layerName,
        paint: {
          "line-color": "#c2410c",
          "line-width": 0.8
        }
      });

      applyFillOpacity(Number(fillOpacityInput.value) / 100);
      setupInteractions(layerName);
    } catch (err) {
      console.error("Error cargando PMTiles:", err);
      document.getElementById("zoom-info").textContent =
        "No se pudo cargar piscinas.pmtiles (revisa la URL y el nombre del archivo).";
    }
  });

  // ---------------------------
  // 3. Interacción y lectura de atributos desde el PMTiles
  // ---------------------------
    function setupInteractions(layerName) {
    const leftPanel = document.getElementById("left-panel");
    const zoomInfo = document.getElementById("zoom-info");

    function pickProp(props, candidates, fallback = "-") {
      for (const c of candidates) {
        if (props[c] !== undefined && props[c] !== null) {
          return props[c];
        }
      }
      return fallback;
    }

    map.on("mouseenter", pondsLayerId, () => {
      map.getCanvas().style.cursor = "pointer";
    });
    map.on("mouseleave", pondsLayerId, () => {
      map.getCanvas().style.cursor = "";
    });

    map.on("click", pondsLayerId, (e) => {
      const feat = e.features && e.features[0];
      if (!feat) return;
      const props = feat.properties || {};

      const id = pickProp(props, ["id", "ID", "pond_id"]);
      const pais = pickProp(props, ["country", "COUNTRY", "pais", "PAIS"]);
      const region = pickProp(props, ["region", "REGION", "provincia", "PROVINCIA", "state"]);
      const lugar = pickProp(props, ["place", "PLACE", "parroquia", "PARROQUIA", "canton", "CANTON"]);
      const area = pickProp(props, ["area_ha", "AREA_HA", "area", "AREA"]);

      let html = "<h2>Estanque seleccionado</h2>";
      html += `<p><strong>ID:</strong> ${id}</p>`;
      html += `<p><strong>País:</strong> ${pais}</p>`;
      html += `<p><strong>Región:</strong> ${region}</p>`;
      html += `<p><strong>Lugar:</strong> ${lugar}</p>`;
      html += `<p><strong>Área (ha):</strong> ${area}</p>`;
      html += `<hr style="border-color:#1f2937; margin:8px 0;">`;
      html += `<p style="font-size:11px; text-transform:uppercase; letter-spacing:.05em; color:#6b7280;">Todas las propiedades del feature</p>`;

      for (const key in props) {
        html += `<p><strong>${key}:</strong> ${props[key]}</p>`;
      }

      leftPanel.innerHTML = html;
    });

    function updateZoomHint() {
      const z = map.getZoom();
      zoomInfo.style.display = z < 8 ? "block" : "none";
    }
    map.on("moveend", updateZoomHint);
    updateZoomHint();
  }

</script>

</body>
</html>
